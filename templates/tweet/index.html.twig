{% extends 'base.html.twig' %}

{% block title %}Tweet index{% endblock %}

{% block body %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css"/>

    <div
        class="w-full flex flex-col items-center justify-start min-h-screen bg-[#15202B] text-white">

        <a class="bg-[#1DA1F2] text-white p-3 mb-6 rounded-lg hover:bg-[#1A91DA] transition" href="{{ path('app_tweet_new') }}">
            Écrire un tweet
        </a>

        <div class="w-full max-w-2xl space-y-4">
            {% if tweets is not empty %}
                {% for tweet in tweets %}
                    <div class="p-4 bg-[#15202B] border border-neutral-700 rounded-xl hover:bg-[#192734] transition">
                        
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-bold">{{ tweet.user.username }}</span>
                                <span class="text-neutral-500">·</span>
                                <span class="text-neutral-400">{{ tweet.createdAt|date('d/m/Y H:i', "Europe/Paris") }}</span>
                            </div>

                            <div class="relative">
                                <button type="button" class="text-neutral-400 hover:text-white" onclick="toggleMenu('{{ tweet.id }}')">
                                    ⋯
                                </button>

                                <div id="menu-{{ tweet.id }}" class="hidden absolute right-0 mt-2 w-40 bg-[#192734] border border-neutral-700 rounded-lg shadow-lg z-10">
                                    {% if app.user %}
                                        {# AUCUNE MODIFICATION ICI : Logique de signalement originale #}
                                        {% set dejaSignale = false %}
                                        {% for r in tweet.reports %}
                                            {% if r.reported == app.user %}
                                                {% set dejaSignale = true %}
                                            {% endif %}
                                        {% endfor %}

                                        {% if dejaSignale %}
                                            <button disabled class="w-full text-left px-4 py-2 text-neutral-400 cursor-not-allowed">
                                                Déjà signalé
                                            </button>
                                        {% else %}
                                            <form action="{{ path('app_report_form', {id: tweet.id}) }}" method="post" data-turbo="false">
                                                <button type="submit" class="w-full text-left px-4 py-2 hover:bg-[#1A91DA] rounded">
                                                    Signaler
                                                </button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="pt-3">
                            <p>{{ tweet.content }}</p>
                        </div>

                        {% if tweet.media %}
                            <img src="{{ asset('uploads/media/' ~ tweet.media) }}" class="mt-3 rounded-md">
                        {% endif %}

                        <div class="flex justify-between items-center mt-3">
                            <div class="flex items-center">
                                <a href="{{ path('app_like_new', {'id':tweet.id})}}" class="text-gray-400 hover:text-red-500 transition-colors duration-300">
                                    <i class="fa-solid fa-heart fa-xs
                                        {% for like in tweet.likes %}
                                            {% if app.user == like.user %}
                                                text-red-500
                                            {% endif %}
                                        {% endfor %}"></i>
                                    <span class="text-white ml-1">{{ tweet.likes.count }}</span>
                                </a>

                                <a href="{{ path('app_retweet_add', {'id': tweet.id})}}" class="ml-2 flex items-center w-fit h-fit hover:text-[#1DA1F2] transition-colors duration-300">
                                    <i class="icon-repeat-2 rounded-lg p-1
                                        {% for retweet in tweet.retweets %}
                                            {% if(app.user == retweet.user) %} text-[#1DA1F2] {% endif %}
                                        {% endfor %}"></i>
                                    <span class="text-white ml-1">{{ tweet.retweets.count }}</span>
                                </a>
                            </div>

                            {# MODIFICATION : Le bouton de suppression n'est visible que par l'auteur du tweet #}
                            {% if app.user == tweet.user %}
                            <form method="POST" 
                                    action="{{ path('app_tweet_delete', {'id': tweet.id}) }}" 
                                    onsubmit="return confirm('Voulez-vous supprimer ce tweet ?');" 
                                    class="inline">
                                
                                <input type="hidden" name="_method" value="DELETE"> 
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ tweet.id) }}">
                                
                                <button type="submit" 
                                        class="text-gray-400 hover:text-red-500 transition-colors duration-300">
                                    <i class="fa-solid fa-trash"></i>
                                    <span class="text-white ml-1"></span>
                                </button>
                            </form>
                            {% endif %}
                            
                        </div>

                    </div>
                {% endfor %}
            {% else %}
                <span class="text-neutral-400">Personne n'a encore écrit de tweet.</span>
            {% endif %}
        </div>
    </div>

    <script>
    function toggleMenu(id) {
        const menu = document.getElementById('menu-' + id);
        document.querySelectorAll('[id^="menu-"]').forEach(m => {
            if (m !== menu) 
                m.classList.add('hidden');
        });
        menu.classList.toggle('hidden');
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('[id^="menu-"]') && !e.target.closest('button[onclick^="toggleMenu"]')) {
            document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
        }
    });
    
    </script>
{% endblock %}